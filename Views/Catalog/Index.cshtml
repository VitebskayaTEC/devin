@{
    ViewBag.Title = "DEVIN | Каталог";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section menu {
    <li>
        <input onkeyup="search(this)" placeholder="Поиск" value="" />
    </li><li>
        <a class="has-icon" onmousedown="_menu(this)" menu="main"><div class="icon ic-menu"></div></a>
    </li>
}


@section scripts {
    <script src="~/content/lib/jquery-3.3.1.min.js"></script>
    <script src="~/content/js/core.js"></script>
    <script>
        function search(input) {
            let s = input.value.toLowerCase();
            if (s === '') {
                document.querySelectorAll(".items tr").forEach(el => el.style.display = '');
            } else {
                document.querySelectorAll(".items tr").forEach(el => {
                    let text = el.querySelector('td').innerHTML.toLowerCase();
                    el.style.display = text.includes(s) ? '' : 'none';
                });
            }
        }

        function cartOpen(node) {
            id = node.id;
            cartOpenBack();
            setHash(id);
        }

        function cartOpenBack() {
            fetch(host + 'catalog/cart/' + id)
                .then(res => res.text())
                .then(text => {
                    let cart = document.getElementById('cart');
                    cart.innerHTML = text;
                    cart.classList.add('cart_visible');

                    let el = document.getElementById(id);
                    if (el) {
                        document.querySelectorAll('.selected').forEach(x => x.classList.remove('selected'));
                        el.classList.add('selected');
                    }
            })
        }
    </script>
}

@section html {
    <div class="context-menu" id="main">
        <a href="~/storages/analyze">Расход картриджей</a>
        <div onclick="Catalog.create('printer')">Создать принтер</div>
        <div onclick="Catalog.create('cartridge')">Создать картридж</div>
    </div>
}

@using (var conn = Database.Connection())
{
    var printers = conn.Query<Printer>("SELECT Id, Name FROM Printers ORDER BY Name");
    var cartridges = conn.Query<Cartridge>("SELECT Id, Name FROM Cartridges ORDER BY Name");

    <table>
        <tr>
            <td width="50%" style="vertical-align: top;">
                <div class="unit">
                    <table class="caption">
                        <tr>
                            <th>Принтеры</th>
                        </tr>
                    </table>
                    <table class="items">
                        @foreach (var printer in printers)
                        {
                            <tr>
                                <td id="prn@(printer.Id)"><a class="view__link" href="##prn@(printer.Id)">@printer.Name</a></td>
                            </tr>
                        }
                    </table>
                </div>
            </td>
            <td width="50%" style="vertical-align: top;">
                <div class="unit">
                    <table class="caption">
                        <tr>
                            <th>Картриджи</th>
                        </tr>
                    </table>
                    <table class="items">
                        @foreach (var cartridge in cartridges)
                        {
                            <tr>
                                <td id="cart@(cartridge.Id)"><a class="view__link" href="##cart@(cartridge.Id)">@cartridge.Name</a></td>
                            </tr>
                        }
                    </table>
                </div>
            </td>
        </tr>
    </table>
}